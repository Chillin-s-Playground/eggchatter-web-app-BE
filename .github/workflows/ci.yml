name: Run Pytest on Push

on:
  pull_request:
    branches:
    - main
    paths:
    - "app/**"

  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test Mode (all | specific)'
        required: true
        default: 'all'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 # git diff ëª…ë ¹ì–´ ì‹¤í–‰ ì‹œ, ì „ì²´ íŒŒì¼ì˜ ížˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìžˆê²Œë”

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11.3'

    - name: Clear pip cache
      run: |
        pip cache purge

    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        poetry cache clear pypi --all
        poetry install --no-interaction --no-root

    - name: Run FastAPI Server
      run: |
        # Poetry í™˜ê²½ì—ì„œ uvicorn ì‹¤í–‰
        nohup poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
        echo "ì„œë²„ ì‹œìž‘ì¤‘..ðŸ¥²"

        # ì„œë²„ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê¸° (ì„œë²„ ì‹œìž‘ ì¤€ë¹„)
        until curl --silent --fail http://localhost:8000; do
          echo "ì„œë²„ ì‹œìž‘ ì¤€ë¹„...ðŸ¤”"
          sleep 2
        done

        # ì„œë²„ê°€ ì¤€ë¹„ë˜ë©´ ë¡œê·¸ë¥¼ ì¶œë ¥í•˜ê³  ì§„í–‰
        echo "ì„œë²„ ì‹œìž‘! ðŸ¥°"
        tail -n 10 server.log

      shell: /usr/bin/bash -e {0}
      env:
        pythonLocation: /opt/hostedtoolcache/Python/3.11.3/x64
        PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.11.3/x64/lib/pkgconfig
        Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.11.3/x64
        Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.11.3/x64
        Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.11.3/x64
        LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.11.3/x64/lib

    - name: Make test script
      run: chmod +x ./t.sh

    - name: Determine test Mode
      id: test_mode
      run: |
        # PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ í™•ì¸
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
        echo "Changed files: $CHANGED_FILES"

        # app/tests/ ê²½ë¡œì— ìžˆëŠ” íŒŒì¼ë§Œ í•„í„°ë§í•´ì„œ test_files í™˜ê²½ ë³€ìˆ˜ì— ì €ìž¥
        TEST_FILES=$(echo "$CHANGED_FILES" | grep '^app/tests/' | tr '\n' ' ')

        # test_files ê°’ì´ ìžˆìœ¼ë©´ specific ëª¨ë“œë¡œ ì‹¤í–‰í•˜ê³ , ì—†ìœ¼ë©´ ì „ì²´ í…ŒìŠ¤íŠ¸(all) ì‹¤í–‰.
        if [[ -n "$TEST_FILES" ]]; then
          echo "mode=specific" >> $GITHUB_ENV
          echo "test_files=$TEST_FILES" >> $GITHUB_ENV
        else
          echo "mode=all" >> $GITHUB_ENV
        fi

    - name: Run Tests
      run: |
        if [[ "$mode" == "specific" ]]; then
          for file in $test_files; do
            filename=$(basename -- "$file")
            echo "FILENAME ðŸš¨ðŸš¨ : $filename"
            poetry run ./t.sh -s "$filename" -f all
          done
        else
          poetry run pytest
        fi
