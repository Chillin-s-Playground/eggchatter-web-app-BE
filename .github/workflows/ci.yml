name: Run Pytest on Push

on:
  pull_request:
    branches:
    - main
    paths:
    - "app/**"

  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test Mode (all | specific)'
        required: true
        default: 'all'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 # git diff 명령어 실행 시, 전체 파일의 히스토리를 가져올 수 있게끔

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11.3'

    - name: Clear pip cache
      run: |
        pip cache purge

    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        poetry cache clear pypi --all
        poetry install --no-interaction --no-root

    - name: Run FastAPI Server
      run: |
        # Poetry 환경에서 uvicorn 실행
        nohup poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
        echo "서버 시작중..🥲"

        # 서버가 준비될 때까지 기다리기 (서버 시작 준비)
        until curl --silent --fail http://localhost:8000; do
          echo "서버 시작 준비...🤔"
          sleep 2
        done

        # 서버가 준비되면 로그를 출력하고 진행
        echo "서버 시작! 🥰"
        tail -n 10 server.log

      shell: /usr/bin/bash -e {0}
      env:
        pythonLocation: /opt/hostedtoolcache/Python/3.11.3/x64
        PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.11.3/x64/lib/pkgconfig
        Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.11.3/x64
        Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.11.3/x64
        Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.11.3/x64
        LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.11.3/x64/lib

    - name: Make test script
      run: chmod +x ./t.sh

    - name: Determine test Mode
      id: test_mode
      run: |
        # PR에서 변경된 파일 목록 확인
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
        echo "Changed files: $CHANGED_FILES"

        # app/tests/ 경로에 있는 파일만 필터링해서 test_files 환경 변수에 저장
        TEST_FILES=$(echo "$CHANGED_FILES" | grep '^app/tests/' | tr '\n' ' ')

        # test_files 값이 있으면 specific 모드로 실행하고, 없으면 전체 테스트(all) 실행.
        if [[ -n "$TEST_FILES" ]]; then
          echo "mode=specific" >> $GITHUB_ENV
          echo "test_files=$TEST_FILES" >> $GITHUB_ENV
        else
          echo "mode=all" >> $GITHUB_ENV
        fi

    - name: Run Tests
      run: |
        if [[ "$mode" == "specific" ]]; then
          for file in $test_files; do
            filename=$(basename -- "$file")
            echo "FILENAME 🚨🚨 : $filename"
            poetry run ./t.sh -s "$filename" -f all
          done
        else
          poetry run pytest
        fi
